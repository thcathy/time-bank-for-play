# Fastlane configuration for EarnTimeToPlay
# https://docs.fastlane.tools

default_platform(:ios)

# ==================== iOS ====================
platform :ios do
  desc "Build and upload to App Store Connect (TestFlight)"
  lane :beta do
    # Ensure Flutter deps + CocoaPods are in sync before archiving
    sh "cd .. && flutter pub get"
    # Run CocoaPods with a clean RubyGems env (Fastlane may set GEM_PATH and break `pod`)
    sh "cd ../ios && env -u GEM_HOME -u GEM_PATH -u BUNDLE_GEMFILE pod install"

    # Increment build number
    increment_build_number(xcodeproj: "ios/Runner.xcodeproj")
    
    # Build the app
    build_app(
      workspace: "ios/Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "build/ios",
      output_name: "EarnTimeToPlay.ipa",
      # Automatic signing (let Xcode manage profiles/certs)
      xcargs: "ENABLE_BITCODE=NO -allowProvisioningUpdates"
    )
    
    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )
  end

  desc "Build and upload to App Store (Production)"
  lane :release do
    # Ensure Flutter deps + CocoaPods are in sync before archiving
    sh "cd .. && flutter pub get"
    # Run CocoaPods with a clean RubyGems env (Fastlane may set GEM_PATH and break `pod`)
    sh "cd ../ios && env -u GEM_HOME -u GEM_PATH -u BUNDLE_GEMFILE pod install"

    # Increment build number
    increment_build_number(xcodeproj: "ios/Runner.xcodeproj")
    
    # Build the app
    build_app(
      workspace: "ios/Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "build/ios",
      output_name: "EarnTimeToPlay.ipa",
      # Automatic signing (let Xcode manage profiles/certs)
      xcargs: "ENABLE_BITCODE=NO -allowProvisioningUpdates"
    )
    
    # Upload to App Store
    # We use upload_to_testflight even for release because it is more reliable for uploading the binary.
    # You can promote the build to App Store from TestFlight later.
    upload_to_testflight(
      ipa: "build/ios/EarnTimeToPlay.ipa",
      skip_waiting_for_build_processing: true
    )
  end

  desc "Build iOS app only (no upload)"
  lane :build do
    # Ensure Flutter deps + CocoaPods are in sync before archiving
    sh "cd .. && flutter pub get"
    # Run CocoaPods with a clean RubyGems env (Fastlane may set GEM_PATH and break `pod`)
    sh "cd ../ios && env -u GEM_HOME -u GEM_PATH -u BUNDLE_GEMFILE pod install"

    build_app(
      workspace: "ios/Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "build/ios",
      output_name: "EarnTimeToPlay.ipa"
    )
  end
end

# ==================== Android ====================
platform :android do
  desc "Build and upload to Google Play (Internal Testing)"
  lane :beta do
    # Build Flutter app bundle
    sh "cd .. && flutter build appbundle --release"
    
    # Upload to Play Store internal testing
    upload_to_play_store(
      track: "internal",
      aab: "build/app/outputs/bundle/release/app-release.aab",
      release_status: "draft",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Build and upload to Google Play (Production)"
  lane :release do
    # Build Flutter app bundle
    sh "cd .. && flutter build appbundle --release"
    
    # Upload to Play Store production
    upload_to_play_store(
      track: "production",
      aab: "build/app/outputs/bundle/release/app-release.aab",
      release_status: "draft",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Build Android app only (no upload)"
  lane :build do
    sh "cd .. && flutter build appbundle --release"
  end
end

# ==================== All Platforms ====================
desc "Build all platforms"
lane :build_all do
  sh "cd .. && flutter clean && flutter pub get"
  
  # Build iOS
  build_app(
    workspace: "ios/Runner.xcworkspace",
    scheme: "Runner",
    export_method: "app-store",
    output_directory: "build/ios",
    output_name: "EarnTimeToPlay.ipa"
  )
  
  # Build Android
  sh "cd .. && flutter build appbundle --release"
  
  puts "âœ… All builds complete!"
  puts "iOS: build/ios/EarnTimeToPlay.ipa"
  puts "Android: build/app/outputs/bundle/release/app-release.aab"
end
